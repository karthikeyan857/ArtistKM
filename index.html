import React, { useState, useRef, useCallback } from "react";
import { AuthProvider, useAuth } from "./contexts/AuthContext";
import { LoginScreen } from "./components/LoginScreen";
import { UserProfile } from "./components/UserProfile";
import { AppNavigation } from "./components/AppNavigation";
import {
  DrawingCanvas,
  DrawingCanvasRef,
} from "./components/DrawingCanvas";
import { DrawingToolbar } from "./components/DrawingToolbar";
import { toast, Toaster } from "sonner@2.0.3";

const DrawingApp: React.FC = () => {
  const { user, isLoading } = useAuth();
  const [currentView, setCurrentView] = useState<
    "drawing" | "profile"
  >("drawing");
  const [brushSize, setBrushSize] = useState(5);
  const [brushColor, setBrushColor] = useState("#000000");
  const [tool, setTool] = useState<
    "brush" | "eraser" | "image"
  >("brush");
  const [backgroundImage, setBackgroundImage] = useState<
    string | undefined
  >();
  const [imagesToAdd, setImagesToAdd] = useState<string[]>([]);
  const canvasRef = useRef<DrawingCanvasRef>(null);

  const canvasWidth = 800;
  const canvasHeight = 600;

  const handleLoadImage = useCallback(
    (file: File) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const result = e.target?.result as string;

        if (tool === "image") {
          setImagesToAdd([result]);
          toast.success("Image added to canvas!");
        } else {
          setBackgroundImage(result);
          toast.success("Background image loaded!");
        }
      };
      reader.readAsDataURL(file);
    },
    [tool],
  );

  const handleSelectGalleryImage = useCallback(
    (imageUrl: string) => {
      if (tool === "image") {
        setImagesToAdd([imageUrl]);
        toast.success("Art image added to canvas!");
      } else {
        setBackgroundImage(imageUrl);
        toast.success("Art background loaded!");
      }
    },
    [tool],
  );

  const handleSelectTemplate = useCallback(
    (templateUrl: string) => {
      setBackgroundImage(templateUrl);
      toast.success("Art template loaded as background!");
    },
    [],
  );

  const handleImagesAdded = useCallback(() => {
    setImagesToAdd([]);
  }, []);

  const handleSave = useCallback(() => {
    if (!canvasRef.current) {
      toast.error("Canvas not found");
      return;
    }

    try {
      const dataUrl = canvasRef.current.exportCanvas();

      if (!dataUrl) {
        const canvas = document.querySelector(
          "canvas",
        ) as HTMLCanvasElement;
        if (!canvas) {
          toast.error("Canvas not found");
          return;
        }

        const link = document.createElement("a");
        link.download = `drawing-${Date.now()}.png`;
        link.href = canvas.toDataURL();

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        const link = document.createElement("a");
        link.download = `artwork-${Date.now()}.png`;
        link.href = dataUrl;

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      toast.success("üé® Artwork saved successfully!");

      // In a real app, you would also save to the user's profile/Supabase
      toast.info("‚ú® Artwork saved to your profile!");
    } catch (error) {
      toast.error("Failed to save artwork");
      console.error("Save error:", error);
    }
  }, []);

  const handleClear = useCallback(() => {
    canvasRef.current?.clearCanvas();
  }, []);

  const handleCanvasChange = useCallback(() => {
    // This can be used for auto-save or other features
  }, []);

  const handleToolChange = useCallback(
    (newTool: "brush" | "eraser" | "image") => {
      setTool(newTool);

      if (newTool === "image") {
        toast.info(
          "üñºÔ∏è Image mode: Select images to add and position them on your canvas",
        );
      } else if (newTool === "brush") {
        toast.info("üñåÔ∏è Brush mode: Paint freely on your canvas");
      } else if (newTool === "eraser") {
        toast.info("üßπ Eraser mode: Remove parts of your drawing");
      }
    },
    [],
  );

  const handleStartDrawing = useCallback(() => {
    setCurrentView("drawing");
  }, []);

  // Show loading spinner while checking authentication
  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-600">Loading Drawing Studio...</p>
        </div>
      </div>
    );
  }

  // Show login screen if user is not authenticated
  if (!user) {
    return <LoginScreen />;
  }

  // Show user profile
  if (currentView === "profile") {
    return (
      <div className="min-h-screen bg-gray-50">
        <AppNavigation
          currentView={currentView}
          onViewChange={setCurrentView}
        />
        <UserProfile onStartDrawing={handleStartDrawing} />
      </div>
    );
  }

  // Show drawing app
  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <AppNavigation
        currentView={currentView}
        onViewChange={setCurrentView}
      />

      {/* Tool indicator */}
      {tool === "image" && (
        <div className="bg-blue-50 border-b border-blue-200 p-2 text-center">
          <div className="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
            üñºÔ∏è Image Mode: Tap to position and resize images
          </div>
        </div>
      )}

      {/* Canvas Container */}
      <div className="flex-1 flex items-center justify-center p-4 overflow-auto">
        <div className="bg-white rounded-lg shadow-lg p-4 max-w-full">
          <DrawingCanvas
            ref={canvasRef}
            width={canvasWidth}
            height={canvasHeight}
            brushSize={brushSize}
            brushColor={brushColor}
            tool={tool}
            backgroundImage={backgroundImage}
            onCanvasChange={handleCanvasChange}
            onClear={() => toast.success("üßπ Canvas cleared!")}
            imagesToAdd={imagesToAdd}
            onImagesAdded={handleImagesAdded}
          />
        </div>
      </div>

      {/* Toolbar */}
      <DrawingToolbar
        brushSize={brushSize}
        brushColor={brushColor}
        tool={tool}
        onBrushSizeChange={setBrushSize}
        onBrushColorChange={setBrushColor}
        onToolChange={handleToolChange}
        onClear={handleClear}
        onSave={handleSave}
        onLoadImage={handleLoadImage}
        onSelectGalleryImage={handleSelectGalleryImage}
        onSelectTemplate={handleSelectTemplate}
      />
    </div>
  );
};

export default function App() {
  return (
    <AuthProvider>
      <DrawingApp />
      <Toaster richColors position="top-center" />
    </AuthProvider>
  );
}